<!DOCTYPE html>
<html lang="en">

<head>
    <title>CounterFit</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">

    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.0.1/dist/css/bootstrap.min.css" rel="stylesheet"
          integrity="sha384-+0n0xVW2eSR5OomGNYDnhzAbDsOXxcvSN1TPprVMTNDbiYZCxYbOOl7+AMvyTG2x" crossorigin="anonymous">
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.0.1/dist/js/bootstrap.bundle.min.js"
            integrity="sha384-gtEjrD/SeCtmISkJkNUaaKMoLD0//ElJ19smozuHV6z3Iehds+3Ulb9Bn9Plx0x4" crossorigin="anonymous"></script>

    <link rel="icon" type="image/png" href="{{ url_for('static', filename='images/favicon.png') }}">

    <script src="{{ url_for('static', filename='socket.io.min.js') }}"></script>
    <script type="text/javascript" charset="utf-8">
        var socket = io();
        socket.on('connect', function () {
            socket.emit('my event', { data: 'I\'m connected!' });
        });
        socket.onmessage = (data) => {
            console.log(data);
        };
        socket.on('device_connect', function(data) {
            var connection_led_title = document.getElementById("connectionLedTitleId")
            var connection_led = document.getElementById("connectionLed")
            var connection_label = document.getElementById("connectionLabel")

            if (data.connected) {
                connection_led_title.innerHTML = "Connected"
                connection_label.innerHTML = "Connected"
                connection_label.style.color = "white"
                connection_led.style.visibility = "visible"
            }  else {
                connection_led_title.innerHTML = "Disconnected"
                connection_label.innerHTML = "Disconnected"
                connection_label.style.color = "grey"
                connection_led.style.visibility = "hidden"
            }
        });
    </script>
</head>

<body class="bg-light" style="background-color: grey!important;">
    <header class="bd-header bg-dark py-3 d-flex align-items-stretch border-bottom border-dark fixed-top">
        <div class="container-fluid d-flex align-items-center">
            <h1 class="d-flex align-items-center fs-4 text-white mb-0">
                <img src="{{ url_for('static', filename='images/CounterFitLogo.png') }}" width="58" height="58"
                    class="me-3" alt="CounterFit logo">
                CounterFit - Fake IoT Hardware
            </h1>

            <div class="ms-auto">
                <span id="connectionLabel"
                {% if is_connected: %}
                      style="color:white;">Connected
                {% else %}
                      style="color:grey;">Disconnected
                {% endif %}
                </span>
                <svg width="24px" height="40px" viewBox="0 0 48 80" version="1.1" 
                        xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"
                        role="img" aria-labelledby="connectionLedTitleId" style="margin-left: 20px;">
                    <title id="connectionLedTitleId">Disconnected</title>
                    <g id="Symbols" stroke="none" stroke-width="1" fill="none" fill-rule="evenodd">
                        <g id="Artboard" transform="translate(0.000000, 2.000000)" fill-rule="nonzero">
                            <g id="LED" transform="translate(0.353000, -0.353000)">
                                <rect id="Base" x="0" y="43.445" width="46.86" height="8.059" fill="#FFFFFF" stroke="#000000" stroke-width="1"></rect>
                                <g id="Pins" transform="translate(6.209000, 47.009000)" fill="#FFFFFF" stroke="#000000" stroke-width="1">
                                    <rect id="Rectangle2" x="0" y="8.8817842e-15" width="6" height="30.557"></rect>
                                    <rect id="Rectangle1" x="28.442" y="8.8817842e-15" width="6" height="30.557"></rect>
                                </g>
                                <path d="M23.43,0 C11.844,0 2.452,9.392 2.452,20.978 L2.452,42.941 L44.407,42.941 L44.407,20.978 C44.408,9.392 35.016,0 23.43,0 Z M40.155,20.791 C40.126,21.09 40.098,21.383 40.071,21.668 C40.011,22.237 39.934,22.776 39.861,23.272 C39.723,24.266 39.553,25.094 39.423,25.673 C39.291,26.253 39.19,26.584 39.19,26.584 C39.19,26.584 39.087,26.253 38.957,25.673 C38.827,25.093 38.655,24.265 38.518,23.272 C38.445,22.775 38.368,22.237 38.308,21.668 C38.281,21.384 38.252,21.092 38.222,20.793 C38.174,20.511 38.141,20.225 38.1,19.934 C38.065,19.645 38.03,19.35 37.994,19.052 C37.952,18.756 37.864,18.462 37.811,18.163 C37.749,17.864 37.682,17.565 37.63,17.262 C37.57,16.96 37.455,16.671 37.372,16.373 L37.123,15.482 C37.025,15.191 36.906,14.908 36.8,14.623 C36.689,14.339 36.586,14.054 36.487,13.769 C36.369,13.495 36.228,13.234 36.11,12.966 C35.989,12.698 35.87,12.435 35.753,12.176 C35.635,11.918 35.477,11.69 35.353,11.448 C35.081,10.982 34.872,10.486 34.597,10.11 C34.332,9.719 34.107,9.335 33.899,8.989 C33.658,8.656 33.447,8.365 33.274,8.127 C32.93,7.642 32.753,7.345 32.753,7.345 C32.753,7.345 33.067,7.491 33.585,7.783 C33.84,7.933 34.163,8.097 34.501,8.331 C34.831,8.587 35.211,8.882 35.608,9.234 C36.037,9.566 36.391,9.996 36.795,10.444 C36.991,10.672 37.203,10.901 37.39,11.156 C37.565,11.42 37.743,11.689 37.924,11.963 C38.104,12.24 38.291,12.521 38.456,12.818 C38.604,13.123 38.754,13.434 38.896,13.751 C39.033,14.07 39.201,14.382 39.314,14.714 L39.625,15.727 C39.715,16.069 39.834,16.404 39.896,16.75 C39.958,17.097 40.002,17.445 40.053,17.79 C40.098,18.134 40.163,18.474 40.172,18.814 C40.173,19.153 40.174,19.49 40.175,19.82 C40.166,20.154 40.168,20.476 40.155,20.791 Z"
                                    stroke="#000000" stroke-width="2" fill="#FFFFFF">
                                </path>
                                <path id="connectionLed" d="M23.43,0 C11.844,0 2.452,9.392 2.452,20.978 L2.452,42.941 L44.407,42.941 L44.407,20.978 C44.408,9.392 35.016,0 23.43,0 Z M40.155,20.791 C40.126,21.09 40.098,21.383 40.071,21.668 C40.011,22.237 39.934,22.776 39.861,23.272 C39.723,24.266 39.553,25.094 39.423,25.673 C39.291,26.253 39.19,26.584 39.19,26.584 C39.19,26.584 39.087,26.253 38.957,25.673 C38.827,25.093 38.655,24.265 38.518,23.272 C38.445,22.775 38.368,22.237 38.308,21.668 C38.281,21.384 38.252,21.092 38.222,20.793 C38.174,20.511 38.141,20.225 38.1,19.934 C38.065,19.645 38.03,19.35 37.994,19.052 C37.952,18.756 37.864,18.462 37.811,18.163 C37.749,17.864 37.682,17.565 37.63,17.262 C37.57,16.96 37.455,16.671 37.372,16.373 L37.123,15.482 C37.025,15.191 36.906,14.908 36.8,14.623 C36.689,14.339 36.586,14.054 36.487,13.769 C36.369,13.495 36.228,13.234 36.11,12.966 C35.989,12.698 35.87,12.435 35.753,12.176 C35.635,11.918 35.477,11.69 35.353,11.448 C35.081,10.982 34.872,10.486 34.597,10.11 C34.332,9.719 34.107,9.335 33.899,8.989 C33.658,8.656 33.447,8.365 33.274,8.127 C32.93,7.642 32.753,7.345 32.753,7.345 C32.753,7.345 33.067,7.491 33.585,7.783 C33.84,7.933 34.163,8.097 34.501,8.331 C34.831,8.587 35.211,8.882 35.608,9.234 C36.037,9.566 36.391,9.996 36.795,10.444 C36.991,10.672 37.203,10.901 37.39,11.156 C37.565,11.42 37.743,11.689 37.924,11.963 C38.104,12.24 38.291,12.521 38.456,12.818 C38.604,13.123 38.754,13.434 38.896,13.751 C39.033,14.07 39.201,14.382 39.314,14.714 L39.625,15.727 C39.715,16.069 39.834,16.404 39.896,16.75 C39.958,17.097 40.002,17.445 40.053,17.79 C40.098,18.134 40.163,18.474 40.172,18.814 C40.173,19.153 40.174,19.49 40.175,19.82 C40.166,20.154 40.168,20.476 40.155,20.791 Z"
                                    stroke="#000000" stroke-width="2" fill="#F98500"
                                    {% if is_connected: %}
                                        visibility="visible"
                                    {% else %}
                                        visibility="hidden"
                                    {% endif %}
                                    >
                                </path>
                            </g>
                        </g>
                    </g>
                </svg>
            </div>
        </div>
    </header>

    <div class="card shadow-sm border-dark" style="margin-left: 10px;margin-right: 10px; margin-bottom: 10px; margin-top: 100px;">
        <div class="card-header py-3">
            <h2 style="text-align:center">Sensors</h2>
        </div>
        <div class="card-body">
            <div class="container-fluid">
                <div class="row">
                    <div class="col-3">
                        <div class="card shadow-sm border-primary" style="margin-top: 11px;">
                            <div class="card-header py-3 text-white bg-primary">
                                <h4 class="my-0 fw-normal" style="text-align:center">Create sensor</h4>
                            </div>
                            <div class="card-body">
                                <div class="container">
                                    <div class="row">
                                      <div class="col">
                                        <label for="new_sensor_type">Sensor Type:</label>
                                      </div>
                                      <div class="col">
                                        <select name="new_sensor_type" id="new_sensor_type" class="form-control">
                                            {% for sensor_type in all_sensors %}
                                            <option value="{{ sensor_type.sensor_name() }}" data-sensortype="{{ sensor_type.sensor_type() }}">{{ sensor_type.sensor_name() }}</option>
                                            {% endfor %}
                                        </select>
                                      </div>
                                    </div>
                                    
                                    <div id="pin_sensor_create_settings" style="display:block">
                                        {% include "pin_sensor_create_settings.html" %}
                                    </div>
                                    
                                    <div id="serial_sensor_create_settings" style="display:none">
                                        {% include "serial_sensor_create_settings.html" %}
                                    </div>
                                    
                                    <div id="binary_sensor_create_settings" style="display:none">
                                        {% include "binary_sensor_create_settings.html" %}
                                    </div>
                                    
                                    <div id="i2c_sensor_create_settings" style="display:none">
                                        {% include "i2c_sensor_create_settings.html" %}
                                    </div>

                                </div>
                            </div>
                            <div class="card-footer">
                                <button type="button" id="add_new_sensor_button" class="w-100 btn btn-lg btn-primary">Add</button>
                            </div>
                        </div>
                    </div>
                    <div class="col-9">
                        <div class="container">
                            <div class="row row-cols-1 row-cols-sm-2 row-cols-sm-3 g-3">
                                
                                {% for sensor in sensors %}
            
                                    <div class="col">
                                        {% if sensor.sensor_type().name == "FLOAT": %}
                                            {% with sensor=sensor %}
                                                {% include "float_sensor.html" %}
                                            {% endwith %}
                                        {% endif %}
                                        {% if sensor.sensor_type().name == "INTEGER": %}
                                            {% with sensor=sensor %}
                                                {% include "integer_sensor.html" %}
                                            {% endwith %}
                                        {% endif %}
                                        {% if sensor.sensor_type().name == "BOOLEAN": %}
                                            {% with sensor=sensor %}
                                                {% include "boolean_sensor.html" %}
                                            {% endwith %}
                                        {% endif %}
                                        {% if sensor.sensor_type().name == "I2C": %}
                                            {% if sensor.sensor_unit_type().name == "FLOAT" %}
                                                {% with sensor=sensor %}
                                                    {% include "i2c_float_sensor.html" %}
                                                {% endwith %}
                                            {% endif %}
                                            {% if sensor.sensor_unit_type().name == "INTEGER" %}
                                                {% with sensor=sensor %}
                                                    {% include "i2c_integer_sensor.html" %}
                                                {% endwith %}
                                            {% endif %}
                                        {% endif %}
                                        {% if sensor.sensor_name() == "UART GPS": %}
                                            {% with sensor=sensor %}
                                                {% include "gps_sensor.html" %}
                                            {% endwith %}
                                        {% endif %}
                                        {% if sensor.sensor_name() == "Camera": %}
                                            {% with sensor=sensor %}
                                                {% include "camera_sensor.html" %}
                                            {% endwith %}
                                        {% endif %}
                                    </div>
            
                                {% endfor %}
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="card shadow-sm border-dark" style="margin: 10px;">
        <div class="card-header py-3">
            <h2 style="text-align:center">Actuators</h2>
        </div>
        <div class="card-body">
            <div class="container-fluid">
                <div class="row">
                    <div class="col-3">
                        <div class="card shadow-sm  border-primary" style="margin-top: 11px;">
                            <div class="card-header py-3 text-white bg-primary">
                                <h4 class="my-0 fw-normal" style="text-align:center">Create actuator</h4>
                            </div>
                            <div class="card-body">
                                <div class="container">
                                    <div class="row">
                                      <div class="col">
                                        <label for="new_actuator_type">Actuator Type:</label>
                                      </div>
                                      <div class="col">
                                        <select name="new_actuator_type" id="new_actuator_type" class="form-control">
                                            {% for actuator_type in all_actuators %}
                                            <option value="{{ actuator_type.actuator_name() }}">{{ actuator_type.actuator_name() }}</option>
                                            {% endfor %}
                                        </select>
                                      </div>
                                    </div>
                                    <div class="row" style="margin-top: 20px;">
                                      <div class="col">
                                        <label for="new_actuator_port">Pin:</label>
                                      </div>
                                      <div class="col">
                                        <select name="new_actuator_port" id="new_actuator_port" class="form-control">
                                            {% for port in ports %}
                                            <option value="{{ port }}">{{ port }}</option>
                                            {% endfor %}
                                        </select>
                                      </div>
                                    </div>
                                </div>
                            </div>
                            <div class="card-footer">
                                <button type="button" id="add_new_actuator_button" class="w-100 btn btn-lg btn-primary" >Add</button>
                            </div>
                        </div>
                    </div>
                    <div class="col-9">
                        <div class="container">
                            <div class="row row-cols-1 row-cols-sm-2 row-cols-sm-3 g-3">
                                
                                {% for actuator in actuators %}

                                <div class="col">
                                    {% if actuator.actuator_name() == "LED": %}
                                        {% with actuator=actuator %}
                                            {% include "led_actuator.html" %}
                                        {% endwith %}
                                    {% elif actuator.actuator_name() == "Relay": %}
                                        {% with actuator=actuator %}
                                            {% include "relay_actuator.html" %}
                                        {% endwith %}
                                    {% endif %}
                                </div>

                                {% endfor %}
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        window.addEventListener("DOMContentLoaded", function () {
            var add_new_sensor_button = document.getElementById("add_new_sensor_button")
            var add_new_actuator_button = document.getElementById("add_new_actuator_button")
            var new_sensor_type_control = document.getElementById("new_sensor_type")
            var new_actuator_type_control = document.getElementById("new_actuator_type")
            var new_sensor_pin_control = document.getElementById("new_sensor_pin")
            var new_i2c_sensor_pin_control = document.getElementById("new_i2c_sensor_pin")
            var new_sensor_port_control = document.getElementById("new_sensor_port")
            var new_sensor_name_control = document.getElementById("new_sensor_name")
            var new_actuator_port_control = document.getElementById("new_actuator_port")
            var new_sensor_units_control = document.getElementById("new_sensor_units")
            var new_i2c_sensor_units_control = document.getElementById("new_i2c_sensor_units")            
            var pin_sensor_create_settings = document.getElementById("pin_sensor_create_settings")
            var serial_sensor_create_settings = document.getElementById("serial_sensor_create_settings")
            var binary_sensor_create_settings = document.getElementById("binary_sensor_create_settings")
            var i2c_sensor_create_settings = document.getElementById("i2c_sensor_create_settings")

            new_sensor_type_control.addEventListener("change", function () {
                var option = new_sensor_type_control.options[new_sensor_type_control.selectedIndex]

                sensor_type = option.getAttribute('data-sensortype')

                if (sensor_type == "SensorType.SERIAL"){
                    pin_sensor_create_settings.style.display = "none"
                    serial_sensor_create_settings.style.display = "block"
                    binary_sensor_create_settings.style.display = "none"
                    i2c_sensor_create_settings.style.display = "none"
                }
                else if (sensor_type == "SensorType.BINARY"){
                    pin_sensor_create_settings.style.display = "none"
                    serial_sensor_create_settings.style.display = "none"
                    binary_sensor_create_settings.style.display = "block"
                    i2c_sensor_create_settings.style.display = "none"
                }
                else if (sensor_type == "SensorType.I2C"){
                    pin_sensor_create_settings.style.display = "none"
                    serial_sensor_create_settings.style.display = "none"
                    binary_sensor_create_settings.style.display = "none"
                    i2c_sensor_create_settings.style.display = "block"
                }
                else {
                    pin_sensor_create_settings.style.display = "block"
                    serial_sensor_create_settings.style.display = "none"
                    binary_sensor_create_settings.style.display = "none"
                    i2c_sensor_create_settings.style.display = "none"
                }
            })

            add_new_sensor_button.addEventListener("click", function () {
                var new_sensor_type = new_sensor_type_control.value
                var new_sensor_unit = new_sensor_units_control.value
                var new_i2c_sensor_unit = new_i2c_sensor_units_control.value
                var new_sensor_pin = parseInt(new_sensor_pin_control.value)
                var new_i2c_sensor_pin = parseInt(new_i2c_sensor_pin_control.value)
                var new_sensor_port = new_sensor_port_control.value
                var new_sensor_name = new_sensor_name_control.value

                var payload = {
                    'type': new_sensor_type,
                    'pin': new_sensor_pin,
                    'i2c_pin': new_i2c_sensor_pin,
                    'port': new_sensor_port,
                    'name': new_sensor_name,
                    'unit': new_sensor_unit,
                    'i2c_unit': new_i2c_sensor_unit
                }

                var xhr = new XMLHttpRequest();
                var url = "./create_sensor";
                xhr.open("POST", url, false);
                xhr.setRequestHeader("Content-Type", "application/json");
                var data = JSON.stringify(payload);
                xhr.send(data);
                location.reload();
            });

            add_new_actuator_button.addEventListener("click", function () {
                var new_actuator_type = new_actuator_type_control.value
                var new_actuator_port = parseInt(new_actuator_port_control.value)

                var payload = {
                    'type': new_actuator_type,
                    'port': new_actuator_port
                }

                var xhr = new XMLHttpRequest();
                var url = "./create_actuator";
                xhr.open("POST", url, false);
                xhr.setRequestHeader("Content-Type", "application/json");
                var data = JSON.stringify(payload);
                xhr.send(data);
                location.reload();
            });

            function populate_units() {
                var new_sensor_type = new_sensor_type_control.value

                var payload = {
                    'type': new_sensor_type,
                }

                var xhr = new XMLHttpRequest();
                var url = "./sensor_units";

                xhr.onreadystatechange = function () {
                    if (xhr.readyState === 4) {
                        response = JSON.parse(xhr.response)
                        var inner = ""
                        response.units.forEach(function (item, index) {
                            inner += "<option value=\"" + item + "\">" + item + "</option>"
                        });

                        new_sensor_units_control.innerHTML = inner
                        new_i2c_sensor_units_control.innerHTML = inner
                    }
                }

                xhr.open("POST", url, false);
                xhr.setRequestHeader("Content-Type", "application/json");
                var data = JSON.stringify(payload);
                xhr.send(data);
            }

            new_sensor_type_control.addEventListener('change', (event) => {
                populate_units()
            });

            populate_units()
        })
    </script>

</body>

</html>